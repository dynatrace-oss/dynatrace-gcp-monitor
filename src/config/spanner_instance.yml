id: spanner_instance
$schema: gcp_schema_v_1_0.json
version: 0.0.1
minDynatraceVersion: 1.199
vars:
- id: filter_conditions
  displayName: Metric query filter for which metrics should be queried
  type: variables
technology:
  name: Google Cloud Spanner Instance
gcp:
- service: spanner_instance
  gcpMonitoringFilter: var:filter_conditions
  dimensions:
  - value: label:resource.labels.project_id
    key: project_id
    compatibilityModeOnly: true
  - value: label:resource.labels.project_id
    key: gcp.project.id
  - value: label:resource.labels.instance_id
    key: instance_id
    compatibilityModeOnly: true
  - value: label:resource.labels.instance_id
    key: gcp.instance.id
  - value: label:resource.labels.location
    key: location
    compatibilityModeOnly: true
  - value: label:resource.labels.location
    key: gcp.region
  - value: label:resource.labels.instance_config
    key: instance_config
  metrics:
  - value: metric:spanner.googleapis.com/api/api_request_count
    key: cloud.gcp.spanner_googleapis_com.api.api_request_count
    type: count,delta
    name: API requests
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: INT64
      metricKind: DELTA
      unit: '1'
    dimensions:
    - value: label:metric.labels.database
      key: database
    - value: label:metric.labels.status
      key: status
    - value: label:metric.labels.method
      key: method
  - value: metric:spanner.googleapis.com/api/received_bytes_count
    key: cloud.gcp.spanner_googleapis_com.api.received_bytes_count
    type: count,delta
    name: Bytes received by Cloud Spanner.
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: INT64
      metricKind: DELTA
      unit: By
    dimensions:
    - value: label:metric.labels.database
      key: database
    - value: label:metric.labels.method
      key: method
  - value: metric:spanner.googleapis.com/api/request_count
    key: cloud.gcp.spanner_googleapis_com.api.request_count
    type: gauge
    name: API request rate
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: DOUBLE
      metricKind: GAUGE
      unit: 1/s
    dimensions:
    - value: label:metric.labels.database
      key: database
    - value: label:metric.labels.status
      key: status
    - value: label:metric.labels.method
      key: method
  - value: metric:spanner.googleapis.com/api/request_latencies
    key: cloud.gcp.spanner_googleapis_com.api.request_latencies
    type: gauge
    name: Request latencies
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: DISTRIBUTION
      metricKind: DELTA
      unit: s
    dimensions:
    - value: label:metric.labels.database
      key: database
    - value: label:metric.labels.method
      key: method
  - value: metric:spanner.googleapis.com/api/sent_bytes_count
    key: cloud.gcp.spanner_googleapis_com.api.sent_bytes_count
    type: count,delta
    name: Bytes sent by Cloud Spanner.
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: INT64
      metricKind: DELTA
      unit: By
    dimensions:
    - value: label:metric.labels.database
      key: database
    - value: label:metric.labels.method
      key: method
  - value: metric:spanner.googleapis.com/instance/backup/used_bytes
    key: cloud.gcp.spanner_googleapis_com.instance.backup.used_bytes
    type: gauge
    name: Backup storage used.
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: INT64
      metricKind: GAUGE
      unit: By
    dimensions:
    - value: label:metric.labels.database
      key: database
    - value: label:metric.labels.backup
      key: backup
  - value: metric:spanner.googleapis.com/instance/cpu/smoothed_utilization
    key: cloud.gcp.spanner_googleapis_com.instance.cpu.smoothed_utilization
    type: gauge
    name: Smoothed CPU utilization
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: DOUBLE
      metricKind: GAUGE
      unit: 10^2.%
    dimensions:
    - value: label:metric.labels.database
      key: database
  - value: metric:spanner.googleapis.com/instance/cpu/utilization
    key: cloud.gcp.spanner_googleapis_com.instance.cpu.utilization
    type: gauge
    name: CPU utilization
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: DOUBLE
      metricKind: GAUGE
      unit: 10^2.%
    dimensions:
    - value: label:metric.labels.database
      key: database
  - value: metric:spanner.googleapis.com/instance/cpu/utilization_by_priority
    key: cloud.gcp.spanner_googleapis_com.instance.cpu.utilization_by_priority
    type: gauge
    name: CPU utilization by priority
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: DOUBLE
      metricKind: GAUGE
      unit: 10^2.%
    dimensions:
    - value: label:metric.labels.database
      key: database
    - value: label:metric.labels.is_system
      key: is_system
    - value: label:metric.labels.priority
      key: priority
  - value: metric:spanner.googleapis.com/instance/node_count
    key: cloud.gcp.spanner_googleapis_com.instance.node_count
    type: gauge
    name: Nodes
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: INT64
      metricKind: GAUGE
      unit: '1'
    dimensions: []
  - value: metric:spanner.googleapis.com/instance/session_count
    key: cloud.gcp.spanner_googleapis_com.instance.session_count
    type: gauge
    name: Sessions
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: INT64
      metricKind: GAUGE
      unit: '1'
    dimensions:
    - value: label:metric.labels.database
      key: database
  - value: metric:spanner.googleapis.com/instance/storage/limit_bytes
    key: cloud.gcp.spanner_googleapis_com.instance.storage.limit_bytes
    type: gauge
    name: Storage limit
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: INT64
      metricKind: GAUGE
      unit: By
    dimensions:
    - value: label:metric.labels.storage_class
      key: storage_class
  - value: metric:spanner.googleapis.com/instance/storage/used_bytes
    key: cloud.gcp.spanner_googleapis_com.instance.storage.used_bytes
    type: gauge
    name: Storage used.
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: INT64
      metricKind: GAUGE
      unit: By
    dimensions:
    - value: label:metric.labels.database
      key: database
    - value: label:metric.labels.storage_class
      key: storage_class
  - value: metric:spanner.googleapis.com/instance/storage/utilization
    key: cloud.gcp.spanner_googleapis_com.instance.storage.utilization
    type: gauge
    name: Storage utilization
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: DOUBLE
      metricKind: GAUGE
      unit: 10^2.%
    dimensions:
    - value: label:metric.labels.storage_class
      key: storage_class
  - value: metric:spanner.googleapis.com/query_count
    key: cloud.gcp.spanner_googleapis_com.query_count
    type: count,delta
    name: Count of queries
    gcpOptions:
      ingestDelay: 120
      samplePeriod: 60
      valueType: INT64
      metricKind: DELTA
      unit: '1'
    dimensions:
    - value: label:metric.labels.database
      key: database
    - value: label:metric.labels.status
      key: status
    - value: label:metric.labels.query_type
      key: query_type
    - value: label:metric.labels.optimizer_version
      key: optimizer_version
alerts:
- path: alerts/spanner_instance/cpu.utilization.json
- path: alerts/spanner_instance/storage.utilization.json
